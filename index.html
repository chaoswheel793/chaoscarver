<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Chaos Carver 4.2 â€” Fixed Carving</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#000; overflow:hidden; touch-action:none; font-family:'Courier New', monospace; color:#ff0044; }
    #ui { position:fixed; inset:0; pointer-events:none; z-index:999; }
    #tap-btn { 
      position:absolute; top:20px; left:50%; transform:translateX(-50%);
      background:#110000; border:3px solid #660000; padding:14px 40px; 
      font-size:20px; letter-spacing:3px; color:#ff3366; pointer-events:all; 
      border-radius:12px; box-shadow:0 0 40px #ff0000; text-transform:uppercase;
    }
    #tap-btn:active { transform:translateX(-50%) scale(0.9); }
    #hand-name { 
      position:absolute; top:80px; left:50%; transform:translateX(-50%); 
      font-size:32px; text-shadow:0 0 25px #ff0044; opacity:0; transition:opacity 2s; 
    }
    #hand-name.visible { opacity:1; }
    #score { position:absolute; bottom:30px; left:30px; font-size:20px; text-shadow:0 0 15px #ff0000; }
    #credits { position:absolute; bottom:10px; right:10px; font-size:12px; color:#660000; pointer-events:all; }
    canvas { display:block; }
  </style>
</head>
<body>
  <div id="ui">
    <button id="tap-btn">HOLD TO CARVE</button>
    <div id="score">Carvings: <span id="count">0</span> | Chaos: <span id="chaos">0</span>%</div>
    <div id="hand-name"></div>
    <a id="credits" href="https://sketchfab.com/3d-models/rigged-hand-eae97cc2a742413cb5338ab942b12c1e" target="_blank">
      Hand by Elena FF (CC-BY 4.0)
    </a>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.module.js';
    import {GLTFLoader} from 'https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/loaders/GLTFLoader.js';

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    const camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 100);
    camera.position.set(0, 1.4, 3.2);

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(devicePixelRatio);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    const hemi = new THREE.HemisphereLight(0xff0044, 0x440044, 1.5);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xff3366, 4);
    dir.position.set(5, 8, 5);
    dir.castShadow = true;
    scene.add(dir);

    const params = new URLSearchParams(location.search);
    const handId = Math.max(1, Math.min(10, parseInt(params.get('hand')) || 1));

    const handThemes = [
      null,
      { name: "Blood Gladiator", color: 0x8B0000, metalness: 0.1, roughness: 0.9, emissive: 0x330000 },
      { name: "Cyber Demon",     color: 0x00ffff, metalness: 0.8, roughness: 0.2, emissive: 0x00cccc },
      { name: "Necro Grasp",     color: 0x00ff00, metalness: 0.3, roughness: 0.7, emissive: 0x003300 },
      { name: "Frost Giant",     color: 0x88ccff, metalness: 0.4, roughness: 0.6, emissive: 0x0066cc },
      { name: "Obsidian Assassin", color: 0x1a1a1a, metalness: 1.0, roughness: 0.0, emissive: 0x330000 },
      { name: "Brass Automaton", color: 0xd4af37, metalness: 1.0, roughness: 0.3, emissive: 0x664400 },
      { name: "Wraith Touch",    color: 0xcccccc, metalness: 0.1, roughness: 0.8, emissive: 0x6666ff, alpha: 0.7 },
      { name: "Dragon Claw",     color: 0x8B0000, metalness: 0.7, roughness: 0.4, emissive: 0xff3300 },
      { name: "Eldritch Horror", color: 0x660066, metalness: 0.5, roughness: 0.5, emissive: 0x990099 },
      { name: "Chaos Architect", color: 0xff0044, metalness: 0.9, roughness: 0.1, emissive: 0xff0044, glow: true }
    ];

    const theme = handThemes[handId];
    document.getElementById('hand-name').textContent = theme.name;
    setTimeout(() => document.getElementById('hand-name').classList.add('visible'), 800);

    let hands = null;
    const loader = new GLTFLoader();
    loader.load("./hand.glb", (gltf) => {
      hands = gltf.scene;
      hands.scale.set(1.3, 1.3, 1.3);
      hands.position.set(0, 0.1, 0.5);
      hands.rotation.set(-0.7, 0, 0);

      hands.traverse(child => {
        if (child.isMesh) {
          child.castShadow = child.receiveShadow = true;
          const mat = child.material = child.material.clone();
          mat.color.set(theme.color);
          mat.metalness = theme.metalness;
          mat.roughness = theme.roughness;
          if (theme.emissive) mat.emissive = new THREE.Color(theme.emissive);
          if (theme.alpha) { mat.transparent = true; mat.opacity = theme.alpha; }
          if (theme.glow) mat.emissiveIntensity = 3;
        }
      });
      scene.add(hands);
    });

    const block = new THREE.Mesh(
      new THREE.BoxGeometry(1.4, 1.4, 1.4),
      new THREE.MeshStandardMaterial({ color: 0x2a2a2a, roughness: 0.8, metalness: 0.3 })
    );
    block.position.y = 0.7;
    block.castShadow = block.receiveShadow = true;
    scene.add(block);

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let isCarving = false;
    let carveCount = 0;
    let chaosLevel = 0;

    const tapBtn = document.getElementById('tap-btn');
    tapBtn.addEventListener('pointerdown', () => {
      isCarving = true;
      tapBtn.textContent = 'CARVING...';
    });
    document.addEventListener('pointerup', () => {
      isCarving = false;
      tapBtn.textContent = 'HOLD TO CARVE';
    });

    const onPointerMove = (e) => {
      if (!isCarving || !block) return;
      e.preventDefault();
      mouse.x = (e.clientX / innerWidth) * 2 - 1;
      mouse.y = -(e.clientY / innerHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const hit = raycaster.intersectObject(block)[0];
      if (hit) {
        carveCount++;
        chaosLevel = Math.min(100, carveCount * 0.8);
        document.getElementById('count').textContent = carveCount;
        document.getElementById('chaos').textContent = Math.floor(chaosLevel);

        const p = new THREE.Mesh(
          new THREE.SphereGeometry(0.015, 4, 4),
          new THREE.MeshBasicMaterial({ color: 0xff3366 })
        );
        p.position.copy(hit.point);
        scene.add(p);
        setTimeout(() => scene.remove(p), 1200);
      }
    };

    document.addEventListener('pointermove', onPointerMove, { passive: false });
    document.addEventListener('touchmove', onPointerMove, { passive: false });

    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      if (chaosLevel > 70) {
        camera.position.x += (Math.random()-0.5)*0.02;
        camera.position.y += (Math.random()-0.5)*0.02;
      }
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>
